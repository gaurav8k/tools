<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forms & File Sharing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 max-w-4xl">

        <!-- Header -->
        <header class="bg-white shadow-md rounded-lg p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Forms & File Sharing</h1>
            <p class="text-gray-600 mt-1">Securely access and manage files.</p>
        </header>

        <!-- Login Section -->
        <section id="login-section" class="bg-white shadow-md rounded-lg p-8 text-center">
            <h2 class="text-2xl font-semibold mb-6">Login</h2>
            <div class="max-w-md mx-auto">
                <input type="email" id="email-input" placeholder="Enter your email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                <div class="flex items-center justify-center mb-6">
                    <input type="checkbox" id="remember-me" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="remember-me" class="ml-2 block text-sm text-gray-900">Remember Me</label>
                </div>
                <button id="send-magic-link-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Send Magic Link</button>
                <p id="login-message" class="mt-4 text-sm text-gray-600"></p>
            </div>
        </section>

        <!-- Main Content (Visible after login) -->
        <main id="main-content" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <p>Logged in as: <span id="user-email" class="font-semibold"></span></p>
                <button id="logout-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-300">Logout</button>
            </div>

            <!-- Admin Section -->
            <section id="admin-section" class="hidden bg-white shadow-md rounded-lg p-8 mb-8">
                <h2 class="text-2xl font-semibold mb-6 border-b pb-4">Admin Dashboard</h2>
                
                <!-- File Upload -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4">Upload New File</h3>
                    <input type="file" id="file-upload-input" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    <button id="upload-btn" class="mt-4 bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition duration-300">Upload File</button>
                    <p id="upload-message" class="mt-2 text-sm"></p>
                </div>

                <!-- Email Management -->
                <div>
                    <h3 class="text-xl font-semibold mb-4">Manage Allowed Visitor Emails</h3>
                    <div class="flex gap-4 mb-4">
                        <input type="email" id="add-email-input" placeholder="Enter visitor email to allow" class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="add-email-btn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-300">Add Email</button>
                    </div>
                    <p id="email-manage-message" class="mb-4 text-sm"></p>
                    <div id="allowed-emails-list" class="space-y-2">
                        <!-- Allowed emails will be dynamically inserted here -->
                    </div>
                </div>
            </section>

            <!-- Visitor Section -->
            <section id="visitor-section" class="hidden bg-white shadow-md rounded-lg p-8">
                <h2 class="text-2xl font-semibold mb-6 border-b pb-4">Available Files</h2>
                <input type="text" id="search-files-input" placeholder="Search for files..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-6">
                <div id="file-list" class="space-y-4">
                    <!-- File list will be dynamically inserted here -->
                </div>
                 <p id="visitor-message" class="mt-4 text-center text-gray-500"></p>
            </section>
        </main>

        <!-- CAPTCHA Modal -->
        <div id="captcha-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
            <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm mx-auto">
                <h3 class="text-xl font-semibold mb-4">Verification Required</h3>
                <p class="mb-4">Please solve the simple math problem to download the file.</p>
                <div class="flex items-center justify-center space-x-2 mb-4">
                    <span id="captcha-question" class="text-2xl font-mono"></span>
                </div>
                <input type="number" id="captcha-input" placeholder="Your Answer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <p id="captcha-error" class="text-red-500 text-sm mt-2"></p>
                <div class="mt-6 flex justify-end space-x-4">
                    <button id="captcha-cancel-btn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 transition">Cancel</button>
                    <button id="captcha-submit-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Submit & Download</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createClient } = supabase;

        // --- SUPABASE CONFIG ---
        // IMPORTANT: Replace with your Supabase project URL and Anon Key
        const SUPABASE_URL = 'https://uinragwdmibhhpyotgso.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVpbnJhZ3dkbWliaGhweW90Z3NvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwNDIyMDQsImV4cCI6MjA2OTYxODIwNH0.uoflUFIBwZVpRWckhqfgeNQUKfgKtY13y8z3L4Dd82Q';
        const ADMIN_EMAIL = 'gaurav8k@gmail.com'; // Change this to your admin's email

        if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
            document.getElementById('app').innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                    <strong class="font-bold">Configuration Needed!</strong>
                    <span class="block sm:inline">Please update the SUPABASE_URL and SUPABASE_ANON_KEY in the script tag with your project credentials. You can find these in your Supabase project's API settings. Also, set your admin email.</span>
                </div>`;
        }

        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM ELEMENTS ---
        const loginSection = document.getElementById('login-section');
        const mainContent = document.getElementById('main-content');
        const adminSection = document.getElementById('admin-section');
        const visitorSection = document.getElementById('visitor-section');
        const userEmailSpan = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const emailInput = document.getElementById('email-input');
        const rememberMeCheckbox = document.getElementById('remember-me');
        const sendMagicLinkBtn = document.getElementById('send-magic-link-btn');
        const loginMessage = document.getElementById('login-message');
        
        // Admin elements
        const fileUploadInput = document.getElementById('file-upload-input');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadMessage = document.getElementById('upload-message');
        const addEmailInput = document.getElementById('add-email-input');
        const addEmailBtn = document.getElementById('add-email-btn');
        const emailManageMessage = document.getElementById('email-manage-message');
        const allowedEmailsList = document.getElementById('allowed-emails-list');

        // Visitor elements
        const searchFilesInput = document.getElementById('search-files-input');
        const fileList = document.getElementById('file-list');
        const visitorMessage = document.getElementById('visitor-message');

        // CAPTCHA elements
        const captchaModal = document.getElementById('captcha-modal');
        const captchaQuestion = document.getElementById('captcha-question');
        const captchaInput = document.getElementById('captcha-input');
        const captchaError = document.getElementById('captcha-error');
        const captchaCancelBtn = document.getElementById('captcha-cancel-btn');
        const captchaSubmitBtn = document.getElementById('captcha-submit-btn');
        let captchaState = {
            answer: 0,
            filePath: null,
            fileName: null
        };


        // --- AUTHENTICATION ---
        
        sendMagicLinkBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            if (!email) {
                loginMessage.textContent = 'Please enter your email.';
                loginMessage.classList.add('text-red-500');
                return;
            }

            sendMagicLinkBtn.disabled = true;
            sendMagicLinkBtn.textContent = 'Sending...';

            const { error } = await db.auth.signInWithOtp({
                email: email,
                options: {
                    shouldCreateUser: true, // Allow new users to sign up
                }
            });

            if (error) {
                loginMessage.textContent = `Error: ${error.message}`;
                loginMessage.classList.add('text-red-500');
            } else {
                loginMessage.textContent = 'Check your email for the magic link!';
                loginMessage.classList.remove('text-red-500');
                loginMessage.classList.add('text-green-500');
            }

            sendMagicLinkBtn.disabled = false;
            sendMagicLinkBtn.textContent = 'Send Magic Link';
        });

        logoutBtn.addEventListener('click', async () => {
            await db.auth.signOut();
            window.location.reload();
        });

        db.auth.onAuthStateChange(async (event, session) => {
            if (session && session.user) {
                const user = session.user;
                await setupUIForUser(user);
            } else {
                showLoginView();
            }
        });

        async function setupUIForUser(user) {
            loginSection.classList.add('hidden');
            mainContent.classList.remove('hidden');
            userEmailSpan.textContent = user.email;

            if (user.email === ADMIN_EMAIL) {
                showAdminView();
                await loadAllowedEmails();
            } else {
                const isAllowed = await checkVisitorPermission(user.email);
                if (isAllowed) {
                    showVisitorView();
                    await loadFiles();
                } else {
                    showAccessDeniedView();
                }
            }
        }

        // --- UI VIEWS ---

        function showLoginView() {
            mainContent.classList.add('hidden');
            loginSection.classList.remove('hidden');
        }

        function showAdminView() {
            visitorSection.classList.add('hidden');
            adminSection.classList.remove('hidden');
        }

        async function showVisitorView() {
            adminSection.classList.add('hidden');
            visitorSection.classList.remove('hidden');
            searchFilesInput.addEventListener('input', filterFiles);
        }

        function showAccessDeniedView() {
            adminSection.classList.add('hidden');
            visitorSection.classList.remove('hidden');
            fileList.innerHTML = '';
            visitorMessage.textContent = 'Access Denied. Your email is not authorized to view files. Please contact the administrator.';
            visitorMessage.classList.add('text-red-500');
        }

        // --- ADMIN FUNCTIONALITY ---

        uploadBtn.addEventListener('click', async () => {
            const file = fileUploadInput.files[0];
            if (!file) {
                uploadMessage.textContent = 'Please select a file to upload.';
                uploadMessage.classList.add('text-red-500');
                return;
            }

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            uploadMessage.textContent = '';
            uploadMessage.classList.remove('text-red-500', 'text-green-500');

            const { error } = await db.storage.from('files').upload(file.name, file, {
                upsert: true // Overwrite file if it already exists
            });

            if (error) {
                uploadMessage.textContent = `Upload failed: ${error.message}`;
                uploadMessage.classList.add('text-red-500');
            } else {
                uploadMessage.textContent = 'File uploaded successfully!';
                uploadMessage.classList.add('text-green-500');
                fileUploadInput.value = ''; // Clear input
            }

            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload File';
        });

        addEmailBtn.addEventListener('click', async () => {
            const email = addEmailInput.value.trim();
            if (!email) {
                emailManageMessage.textContent = 'Please enter an email address.';
                emailManageMessage.classList.add('text-red-500');
                return;
            }

            const { error } = await db.from('allowed_emails').insert({ email: email });
            
            emailManageMessage.textContent = '';
            emailManageMessage.classList.remove('text-red-500', 'text-green-500');

            if (error) {
                if(error.code === '23505') { // unique constraint violation
                    emailManageMessage.textContent = `Error: Email '${email}' is already on the list.`;
                } else {
                    emailManageMessage.textContent = `Error: ${error.message}`;
                }
                emailManageMessage.classList.add('text-red-500');
            } else {
                emailManageMessage.textContent = `Email '${email}' added successfully.`;
                emailManageMessage.classList.add('text-green-500');
                addEmailInput.value = '';
                await loadAllowedEmails(); // Refresh the list
            }
        });

        async function loadAllowedEmails() {
            const { data, error } = await db.from('allowed_emails').select('id, email');
            if (error) {
                allowedEmailsList.innerHTML = `<p class="text-red-500">Error loading emails: ${error.message}</p>`;
                return;
            }

            allowedEmailsList.innerHTML = data.length > 0 ? '' : '<p>No visitor emails added yet.</p>';
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg';
                div.innerHTML = `
                    <span>${item.email}</span>
                    <button data-id="${item.id}" class="remove-email-btn text-red-500 hover:text-red-700 font-semibold">Remove</button>
                `;
                allowedEmailsList.appendChild(div);
            });

            document.querySelectorAll('.remove-email-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    await removeEmail(id);
                });
            });
        }

        async function removeEmail(id) {
            const { error } = await db.from('allowed_emails').delete().match({ id: id });
            if (error) {
                emailManageMessage.textContent = `Error removing email: ${error.message}`;
                emailManageMessage.classList.add('text-red-500');
            } else {
                emailManageMessage.textContent = `Email removed successfully.`;
                emailManageMessage.classList.add('text-green-500');
                await loadAllowedEmails(); // Refresh list
            }
        }

        // --- VISITOR FUNCTIONALITY ---

        async function checkVisitorPermission(email) {
            const { data, error } = await db.from('allowed_emails').select('email').eq('email', email).single();
            return !!data && !error;
        }

        async function loadFiles() {
            visitorMessage.textContent = 'Loading files...';
            const { data, error } = await db.storage.from('files').list();

            if (error) {
                fileList.innerHTML = `<p class="text-red-500">Error loading files: ${error.message}</p>`;
                visitorMessage.textContent = '';
                return;
            }
            
            if (!data || data.filter(f => f.name !== '.emptyFolderPlaceholder').length === 0) {
                 visitorMessage.textContent = 'No files are available at the moment.';
                 fileList.innerHTML = '';
                 return;
            }
            
            visitorMessage.textContent = '';
            fileList.innerHTML = '';
            data.forEach(file => {
                // Ignore Supabase's empty placeholder folder
                if (file.name === '.emptyFolderPlaceholder') return;

                const div = document.createElement('div');
                div.className = 'file-item flex justify-between items-center bg-gray-50 p-4 rounded-lg';
                div.innerHTML = `
                    <div>
                        <p class="font-semibold file-name">${file.name}</p>
                        <p class="text-sm text-gray-500">Last modified: ${new Date(file.updated_at).toLocaleString()}</p>
                    </div>
                    <button data-path="${file.name}" class="download-btn bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition">Download</button>
                `;
                fileList.appendChild(div);
            });

            document.querySelectorAll('.download-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const filePath = e.target.dataset.path;
                    initiateDownload(filePath);
                });
            });
        }
        
        function filterFiles() {
            const searchTerm = searchFilesInput.value.toLowerCase();
            const files = document.querySelectorAll('.file-item');
            let foundFiles = false;
            files.forEach(file => {
                const fileName = file.querySelector('.file-name').textContent.toLowerCase();
                if (fileName.includes(searchTerm)) {
                    file.style.display = 'flex';
                    foundFiles = true;
                } else {
                    file.style.display = 'none';
                }
            });
            visitorMessage.textContent = foundFiles ? '' : 'No files match your search.';
        }


        // --- CAPTCHA & DOWNLOAD LOGIC ---
        
        function initiateDownload(filePath) {
            const num1 = Math.floor(Math.random() * 10) + 1;
            const num2 = Math.floor(Math.random() * 10) + 1;
            captchaState.answer = num1 + num2;
            captchaState.filePath = filePath;
            captchaState.fileName = filePath.split('/').pop();

            captchaQuestion.textContent = `${num1} + ${num2} = ?`;
            captchaInput.value = '';
            captchaError.textContent = '';
            captchaModal.classList.remove('hidden');
        }

        captchaCancelBtn.addEventListener('click', () => {
            captchaModal.classList.add('hidden');
        });

        captchaSubmitBtn.addEventListener('click', async () => {
            const userAnswer = parseInt(captchaInput.value, 10);
            if (userAnswer === captchaState.answer) {
                captchaModal.classList.add('hidden');
                await downloadFile(captchaState.filePath, captchaState.fileName);
            } else {
                captchaError.textContent = 'Incorrect answer. Please try again.';
            }
        });

        async function downloadFile(filePath, fileName) {
            captchaSubmitBtn.disabled = true;
            captchaSubmitBtn.textContent = 'Generating Link...';

            // Create a signed URL that expires in 60 seconds
            const { data, error } = await db.storage.from('files').createSignedUrl(filePath, 60);

            if (error) {
                alert(`Error creating download link: ${error.message}`);
                captchaSubmitBtn.disabled = false;
                captchaSubmitBtn.textContent = 'Submit & Download';
                return;
            }

            // Create a temporary link to trigger the download
            const link = document.createElement('a');
            link.href = data.signedUrl;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            captchaSubmitBtn.disabled = false;
            captchaSubmitBtn.textContent = 'Submit & Download';
        }

    </script>
</body>
</html>
